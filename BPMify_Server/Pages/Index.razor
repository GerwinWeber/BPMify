@page "/"
@using SpotifyAPI.Web
@using System.Runtime

@inject NavigationManager navManager
@inject HttpClient http




<h1>Hello, world!</h1>

@if (_isAuthed)
{

}
else
{
    <a class="btn btn-primary" @onclick="NavigateToSpotifyLogin">
        Login
    </a>
}



<div>@temp</div>
<span class="mt-4"></span>
<div class="btn btn-primary" @onclick="CheckForRecievedCode">Check for code</div>


@code{

    private Uri _authUri;

    private const string _clientId = "12b474707a0d41d08a6cd91bd49e56a6";
    private const string _response_type = "code";
    private Uri _redirectUri = new Uri("https://localhost:44359/");
    private string _spotifyScopes = @"user-read-currently-playing%20user-read-playback-state%20user-modify-playback-state%20streaming%20user-read-email%20user-read-private%20playlist-read-private";
    private string SpotifyAuthUrl = "";
    private string _verfier = "";
    private string _challenge = "";

    private bool _isAuthed = false;
    private bool _codeRecieved = false;

    private string _code = "";
    private Uri _uri = new Uri("https://localhost:44359//callback");
    private Uri _currentUri;

    private string temp = "";



    protected override async Task OnInitializedAsync()
    {
        CheckForRecievedCode();
        if (_codeRecieved)
        {
            await BuiltPostRequest();
        }
        else
        {

        }
    }


    private void CheckForRecievedCode()
    {
        _currentUri = new Uri(navManager.Uri);
        Console.WriteLine(_currentUri.Query);

        if (String.IsNullOrEmpty(_currentUri.Query) || !_currentUri.Query.Contains("?code="))
        {
            _codeRecieved = false;
        }
        else
        {
            _codeRecieved = true;
        }
    }

    private async Task BuiltPostRequest()
    {

        _code = _currentUri.Query.Substring(6);//localhost:44359/?code=<code>
        temp = $"_code: {_currentUri.Query}; _verifier: {_verfier} ";

        //http://ronaldrosiernet.azurewebsites.net/Blog/2013/12/07/posting_urlencoded_key_values_with_httpclient
        var client = new HttpClient();
        client.BaseAddress = new Uri("https://accounts.spotify.com");
        var request = new HttpRequestMessage(HttpMethod.Post, "/api/token");

        var keyValues = new List<KeyValuePair<string, string>>();
        keyValues.Add(new KeyValuePair<string, string>("client_id", _clientId));
        keyValues.Add(new KeyValuePair<string, string>("grant_type", "authorization_code"));
        keyValues.Add(new KeyValuePair<string, string>("code", _code));
        keyValues.Add(new KeyValuePair<string, string>("redirect_uri", _redirectUri.ToString()));
        //_verfier must be storaged locally
        keyValues.Add(new KeyValuePair<string, string>("code_verifier", _verfier));

        request.Content = new FormUrlEncodedContent(keyValues);
        var response = await client.SendAsync(request);
    }

    public void NavigateToSpotifyLogin()
    {
        //_verfier and _challenge must be storaged locally
        (_verfier, _challenge) = PKCEUtil.GenerateCodes(120);
        SpotifyAuthUrl = "https://accounts.spotify.com/en/authorize?client_id=" + _clientId + $"&response_type=code&redirect_uri={_redirectUri}&scope={_spotifyScopes}&code_challenge={_challenge}&code_challenge_method=S256";
        navManager.NavigateTo(SpotifyAuthUrl);
        //navManager.NavigateTo(@"https://accounts.spotify.com/en/authorize?client_id=12b474707a0d41d08a6cd91bd49e56a6&response_type=code&redirect_uri=https:%2F%2Flocalhost:44359%2F&scope=user-read-currently-playing%20user-read-playback-state%20user-modify-playback-state%20streaming%20user-read-email%20user-read-private%20playlist-read-private");
    }

    private void GenerateLoginURI()
    {


        //// Make sure "https://localhost:44359/" is in your applications redirect URIs!
        //var loginRequest = new LoginRequest(
        //  _redirectUri,
        //  "12b474707a0d41d08a6cd91bd49e56a6",
        //  LoginRequest.ResponseType.Code
        //)

        //{
        //    CodeChallengeMethod = "S256",
        //    CodeChallenge = challenge,
        //    Scope = new[] { Scopes.PlaylistReadPrivate, Scopes.PlaylistReadCollaborative }
        //};

        //_verfier = verifier;
        //_challenge = challenge;
        ////_code = LoginRequest.ResponseType.Code;
        //var _authUri = loginRequest.ToUri();
        ////temp = $"Verifier: {_verfier} ; Challenge: {_challenge}; Code: {LoginRequest.ResponseType.Code}; _authUri: {_authUri}";

        // Redirect user to uri via your favorite web-server or open a local browser window
    }

    // This method should be called from your web-server when the user visits "https://localhost:44359/"
    //public async Task GetCallback(string code)
    //{
    //    //_code = _uri.Query.Substring(6); //localhost:44304/?code=<code>
    //    //temp = $"Verifier: {_verfier} ; Challenge: {_challenge} ; Uri: {_uri}; Code: {code}";

    //    // Note that we use the verifier calculated above!
    //    var initialResponse = await new OAuthClient().RequestToken(
    //      new PKCETokenRequest(_clientId, code, _redirectUri, _verfier)
    //    );

    //    var spotify = new SpotifyClient(initialResponse.AccessToken);
    //    temp = $"Verifier: {_verfier} ; Challenge: {_challenge} ; Access Token: {initialResponse.AccessToken}";
    //    Console.WriteLine(initialResponse.AccessToken);
    //    _isAuthed = true;
    //    // Also important for later: response.RefreshToken
    //}





    /*
    ZIEL:
https://accounts.spotify.com/en/authorize?client_id=12b474707a0d41d08a6cd91bd49e56a6&response_type=code&redirect_uri=https:%2F%2Flocalhost:44359%2F&scope=user-read-currently-playing%20user-read-playback-state%20user-modify-playback-state%20streaming%20user-read-email%20user-read-private%20playlist-read-private
    */

}
